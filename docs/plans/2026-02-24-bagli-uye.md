# Bağlı Üye (Çocuk) Sistemi Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Email'i olmayan çocuk üyeleri veliye bağlayarak, velinin kendi dashboard'unda çocuğun ders takibi ve fiziksel ilerleme grafiğini görmesini sağlamak.

**Architecture:** `users` tablosuna `parent_id` sütunu eklenir. Çocuk üye, sahte email (`child-{uuid}@hamzapt.local`) ile auth hesabı oluşturularak kaydedilir — giriş yapmaz. Admin panelinde "Bağlı Üye Ekle" seçeneği eklenir. Velinin dashboard'una çocuğun özet kartı + ilerleme grafiği eklenir. RLS politikaları güncellenerek veli, çocuğun verilerini görebilir.

**Tech Stack:** Supabase (migration + RLS), Next.js App Router, TypeScript, Recharts (mevcut ProgressChart)

---

### Task 1: Migration — `parent_id` sütunu + RLS güncellemesi

**Files:**
- Create: `supabase/migrations/024_dependent_members.sql`

**Step 1: Migration dosyasını yaz**

```sql
-- Bağlı üye (çocuk) desteği
ALTER TABLE public.users ADD COLUMN parent_id UUID REFERENCES public.users(id) ON DELETE SET NULL;
CREATE INDEX idx_users_parent_id ON public.users(parent_id);

-- RLS: Veli, çocuğunun verisini görebilsin

-- users: veli çocuğu görebilir
DROP POLICY IF EXISTS "users_select_own" ON public.users;
CREATE POLICY "users_select_own" ON public.users
  FOR SELECT USING (
    auth.uid() = id
    OR id IN (SELECT u.id FROM public.users u WHERE u.parent_id = auth.uid())
    OR EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
  );

-- packages: veli çocuğun paketlerini görebilir
DROP POLICY IF EXISTS "packages_select" ON public.packages;
CREATE POLICY "packages_select" ON public.packages
  FOR SELECT USING (
    user_id = auth.uid()
    OR user_id IN (SELECT u.id FROM public.users u WHERE u.parent_id = auth.uid())
    OR EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
  );

-- lessons: veli çocuğun derslerini görebilir
DROP POLICY IF EXISTS "lessons_select" ON public.lessons;
CREATE POLICY "lessons_select" ON public.lessons
  FOR SELECT USING (
    user_id = auth.uid()
    OR user_id IN (SELECT u.id FROM public.users u WHERE u.parent_id = auth.uid())
    OR EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
  );

-- measurements: veli çocuğun ölçümlerini görebilir
DROP POLICY IF EXISTS "measurements_select" ON public.measurements;
CREATE POLICY "measurements_select" ON public.measurements
  FOR SELECT USING (
    user_id = auth.uid()
    OR user_id IN (SELECT u.id FROM public.users u WHERE u.parent_id = auth.uid())
    OR EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
  );
```

**Step 2: Migration'ı push et**

Run: `npx supabase db push --linked`

**Step 3: Commit**

```bash
git add supabase/migrations/024_dependent_members.sql
git commit -m "feat: bağlı üye (çocuk) için parent_id sütunu ve RLS güncellemesi"
```

---

### Task 2: Types + API — Bağlı üye oluşturma endpoint'i

**Files:**
- Modify: `src/lib/types.ts` — User interface'e `parent_id` ekle
- Modify: `src/app/api/admin/members/route.ts` — POST'a `parent_id` desteği ekle

**Step 1: Types güncelle**

`src/lib/types.ts` → User interface'e ekle:
```typescript
export interface User {
  id: string
  email: string
  full_name: string
  phone: string | null
  role: UserRole
  gender: Gender | null
  start_date: string
  is_active: boolean
  created_at: string
  parent_id: string | null  // ← ekle
}
```

**Step 2: API route'u güncelle**

`src/app/api/admin/members/route.ts` → POST handler'da `parent_id` desteği:

- Body'den `parent_id` al
- `parent_id` varsa: email → `child-{uuid}@hamzapt.local`, password → `crypto.randomUUID()` (rastgele, kimse kullanmayacak)
- `email_confirm: false` zaten mevcut
- Auth user oluşturduktan sonra `parent_id`'yi `users` tablosuna set et

```typescript
const { email: rawEmail, password: rawPassword, full_name, phone, gender, parent_id } = body

// Bağlı üye ise sahte email/şifre oluştur
const isDependent = !!parent_id
const email = isDependent ? `child-${crypto.randomUUID()}@hamzapt.local` : rawEmail
const password = isDependent ? crypto.randomUUID() : rawPassword

if (!isDependent && (!email || !password)) {
  return NextResponse.json({ error: 'Gerekli alanlar eksik' }, { status: 400 })
}
if (!full_name) {
  return NextResponse.json({ error: 'Gerekli alanlar eksik' }, { status: 400 })
}
```

Auth user oluşturduktan sonra:
```typescript
// Profil güncelle
const profileUpdate: Record<string, string | null> = {}
if (phone) profileUpdate.phone = phone
if (gender) profileUpdate.gender = gender
if (parent_id) profileUpdate.parent_id = parent_id
if (Object.keys(profileUpdate).length > 0) {
  await adminClient.from('users').update(profileUpdate).eq('id', authData.user.id)
}

// Bağlı üye ise onay maili gönderme
if (!isDependent) {
  await adminClient.auth.resend({ type: 'signup', email })
}
```

**Step 3: Commit**

```bash
git add src/lib/types.ts src/app/api/admin/members/route.ts
git commit -m "feat: bağlı üye oluşturma API desteği"
```

---

### Task 3: Admin Panel — "Bağlı Üye Ekle" butonu + form

**Files:**
- Modify: `src/app/(admin)/admin/members/[id]/MemberDetail.tsx` — Bağlı üye ekleme butonu + modal

**Step 1: MemberDetail'a bağlı üye ekleme**

Genel Bakış tabında, mevcut bilgilerin altına:
- "Bağlı Üyeler" bölümü ekle
- Bağlı üye varsa listele (isim + link)
- "Bağlı Üye Ekle" butonu → Modal (sadece ad soyad + cinsiyet, email/şifre yok)
- Ekleme sonrası router.refresh()

Modal formu:
- Ad Soyad (zorunlu)
- Cinsiyet (zorunlu)
- Telefon (opsiyonel)

POST isteği: `{ full_name, gender, phone, parent_id: member.id }`

**Step 2: Bağlı üyeleri page.tsx'te çek**

`src/app/(admin)/admin/members/[id]/page.tsx` → mevcut query'lere ekle:
```typescript
const { data: dependents } = await supabase
  .from('users')
  .select('id, full_name, is_active, gender')
  .eq('parent_id', id)
```

Bunu MemberDetail'a `dependents` prop olarak geçir.

**Step 3: MembersList'te bağlı üyeleri göster**

`src/app/(admin)/admin/members/MembersList.tsx` → Bağlı üyeleri gizle (parent_id null olanları göster) + üye kartında bağlı üye sayısını badge olarak göster.

**Step 4: Commit**

```bash
git add src/app/(admin)/admin/members/
git commit -m "feat: admin panelde bağlı üye ekleme ve listeleme"
```

---

### Task 4: Üye Dashboard — Çocuğun özet kartı

**Files:**
- Modify: `src/app/(member)/dashboard/page.tsx`

**Step 1: Çocuk verilerini çek**

Dashboard server component'te mevcut query'lere ekle:
```typescript
// Bağlı üyeler (çocuklar)
const { data: dependents } = await supabase
  .from('users')
  .select('id, full_name, gender')
  .eq('parent_id', user.id)
```

Her çocuk için aktif paket + son ölçüm çek:
```typescript
const dependentData = await Promise.all(
  (dependents || []).map(async (dep) => {
    const [{ data: pkg }, { data: measurement }] = await Promise.all([
      supabase.from('packages').select('*').eq('user_id', dep.id).eq('status', 'active')
        .order('created_at', { ascending: false }).limit(1).maybeSingle(),
      supabase.from('measurements').select('*').eq('user_id', dep.id)
        .order('date', { ascending: false }).limit(1).maybeSingle(),
    ])
    return { ...dep, activePackage: pkg, recentMeasurement: measurement }
  })
)
```

**Step 2: Çocuk kartını render et**

Hoşgeldin kartından sonra, her çocuk için bir kart:
- Çocuğun adı
- Aktif paket: kalan ders + progress bar + uyarı badge
- Son ölçüm özeti (kilo, yağ %)
- "İlerlemeyi Gör →" linki → `/dashboard/cocuk/{childId}/ilerleme`

**Step 3: Commit**

```bash
git add src/app/(member)/dashboard/page.tsx
git commit -m "feat: veli dashboard'unda çocuk özet kartı"
```

---

### Task 5: Üye Dashboard — Çocuğun ilerleme sayfası

**Files:**
- Create: `src/app/(member)/dashboard/cocuk/[id]/ilerleme/page.tsx`

**Step 1: İlerleme sayfasını oluştur**

Mevcut `/dashboard/progress/page.tsx` ile aynı mantık, ama `user.id` yerine `params.id` (çocuğun ID'si) kullanılır.

Güvenlik: Çocuğun `parent_id`'sinin `auth.uid()` ile eşleştiğini kontrol et:
```typescript
const { data: child } = await supabase
  .from('users')
  .select('id, full_name, gender, parent_id')
  .eq('id', childId)
  .single()

if (!child || child.parent_id !== user.id) redirect('/dashboard')
```

Sonra ölçümleri çekip mevcut `ProgressChart` component'ini kullan:
```tsx
<ProgressChart measurements={measurements || []} gender={child.gender} />
```

**Step 2: Commit**

```bash
git add src/app/(member)/dashboard/cocuk/
git commit -m "feat: veli çocuğun ilerleme grafiğini görebilir"
```

---

### Task 6: Verify + Deploy

**Step 1: Dev server'da test et**
- Admin: bağlı üye ekle → listede görünür mü?
- Veli dashboard: çocuk kartı görünüyor mu?
- Çocuk ilerleme sayfası: grafik çalışıyor mu?
- Bağlı üye ana üye listesinde gizli mi?

**Step 2: Build kontrolü**
Run: `npx next build`

**Step 3: Deploy**
Run: `npx vercel --prod`

**Step 4: Final commit**
```bash
git add -A
git commit -m "feat: bağlı üye sistemi — email'siz çocuk üye kaydı ve veli takibi"
```
